<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmolVLM Local Motion Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #4CAF50;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #888;
            font-size: 1rem;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .video-section {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .video-container {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            margin-bottom: 15px;
        }
        
        #videoElement {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .motion-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(76, 175, 80, 0.8);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .motion-indicator.active {
            opacity: 1;
            background: rgba(255, 152, 0, 0.8);
            animation: pulse 1s infinite;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .btn {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.secondary {
            background: #2196F3;
        }
        
        .btn.secondary:hover:not(:disabled) {
            background: #1976D2;
        }
        
        .settings-row {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .setting-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .setting-group label {
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .setting-group input, .setting-group select {
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f44336;
        }
        
        .status-dot.active {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        .text-output-section {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .text-output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .text-output-header h2 {
            color: #4CAF50;
            font-size: 1.3rem;
        }
        
        .clear-btn {
            background: #f44336;
            font-size: 0.8rem;
            padding: 6px 12px;
        }
        
        .clear-btn:hover:not(:disabled) {
            background: #d32f2f;
        }
        
        .text-output {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .output-entry {
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 4px;
            background: rgba(76, 175, 80, 0.1);
            border-left: 3px solid #4CAF50;
        }
        
        .output-timestamp {
            color: #888;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        
        .output-text {
            color: #e0e0e0;
            white-space: pre-wrap;
        }
        
        .loading-indicator {
            color: #FFC107;
            font-style: italic;
        }
        
        .error-entry {
            background: rgba(244, 67, 54, 0.1);
            border-left-color: #f44336;
        }
        
        .model-status {
            background: #333;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .model-loading {
            color: #FFC107;
        }
        
        .model-ready {
            color: #4CAF50;
        }
        
        .model-error {
            color: #f44336;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @media (max-width: 768px) {
            .settings-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/onnxruntime-web/1.16.3/ort.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ SmolVLM Motion Detection</h1>
            <p>Local vision analysis triggered by motion detection</p>
        </div>
        
        <div class="main-layout">
            <div class="video-section">
                <div class="model-status">
                    <div id="modelStatus" class="model-loading">üîÑ Loading vision model...</div>
                </div>
                
                <div class="video-container">
                    <video id="videoElement" autoplay muted playsinline></video>
                    <div id="motionIndicator" class="motion-indicator">Motion Detected!</div>
                </div>
                
                <div class="settings-row">
                    <div class="setting-group">
                        <label>Motion Sensitivity:</label>
                        <input type="range" id="motionThreshold" min="10" max="100" value="30">
                        <span id="thresholdValue">30</span>
                    </div>
                    <div class="setting-group">
                        <label>Analysis Cooldown:</label>
                        <select id="cooldownTime">
                            <option value="3000">3 seconds</option>
                            <option value="5000" selected>5 seconds</option>
                            <option value="10000">10 seconds</option>
                            <option value="15000">15 seconds</option>
                        </select>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="startBtn" class="btn">üìπ Start Camera</button>
                    <button id="stopBtn" class="btn" disabled>‚èπÔ∏è Stop</button>
                    <button id="analyzeBtn" class="btn secondary" disabled>üîç Analyze Now</button>
                </div>
                
                <div class="status-bar">
                    <div class="status-item">
                        <div id="cameraStatus" class="status-dot"></div>
                        <span id="cameraStatusText">Camera: Inactive</span>
                    </div>
                    <div class="status-item">
                        <div id="motionStatus" class="status-dot"></div>
                        <span id="motionStatusText">Motion: None</span>
                    </div>
                    <div class="status-item">
                        <div id="analysisStatus" class="status-dot"></div>
                        <span id="analysisStatusText">Analysis: Ready</span>
                    </div>
                </div>
            </div>
            
            <div class="text-output-section">
                <div class="text-output-header">
                    <h2>üìù Analysis Output</h2>
                    <button id="clearOutputBtn" class="btn clear-btn">Clear</button>
                </div>
                <div id="textOutput" class="text-output">
                    <div class="output-entry">
                        <div class="output-timestamp">Ready</div>
                        <div class="output-text">Waiting for camera to start and motion to be detected...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MotionDetectionVLM {
            constructor() {
                this.video = document.getElementById('videoElement');
                this.textOutput = document.getElementById('textOutput');
                this.motionIndicator = document.getElementById('motionIndicator');
                this.modelStatus = document.getElementById('modelStatus');
                
                // Canvas for motion detection
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.prevImageData = null;
                
                // Canvas for analysis
                this.analysisCanvas = document.createElement('canvas');
                this.analysisCtx = this.analysisCanvas.getContext('2d');
                
                // State
                this.stream = null;
                this.motionDetectionInterval = null;
                this.lastAnalysisTime = 0;
                this.isAnalyzing = false;
                this.model = null;
                this.processor = null;
                
                // Settings
                this.motionThreshold = 30;
                this.cooldownTime = 5000;
                
                this.initializeEventListeners();
                this.initializeModel();
                this.updateStatus();
            }
            
            initializeEventListeners() {
                document.getElementById('startBtn').addEventListener('click', () => this.startCamera());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopCamera());
                document.getElementById('analyzeBtn').addEventListener('click', () => this.performAnalysis(true));
                document.getElementById('clearOutputBtn').addEventListener('click', () => this.clearOutput());
                
                // Settings
                const motionSlider = document.getElementById('motionThreshold');
                motionSlider.addEventListener('input', (e) => {
                    this.motionThreshold = parseInt(e.target.value);
                    document.getElementById('thresholdValue').textContent = e.target.value;
                });
                
                document.getElementById('cooldownTime').addEventListener('change', (e) => {
                    this.cooldownTime = parseInt(e.target.value);
                });
            }
            
            async initializeModel() {
                try {
                    this.addOutput('üîÑ Initializing local vision model...', 'loading');
                    
                    // For demonstration, we'll simulate model loading
                    // In real implementation, you would load a smaller vision model here
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Simulate successful model loading
                    this.model = { ready: true }; // Placeholder
                    
                    this.modelStatus.textContent = '‚úÖ Vision model ready';
                    this.modelStatus.className = 'model-ready';
                    this.addOutput('‚úÖ Local vision model loaded successfully', 'success');
                    
                } catch (error) {
                    this.modelStatus.textContent = '‚ùå Model loading failed';
                    this.modelStatus.className = 'model-error';
                    this.addOutput(`‚ùå Failed to load model: ${error.message}`, 'error');
                }
            }
            
            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }
                    });
                    
                    this.video.srcObject = this.stream;
                    
                    this.video.onloadedmetadata = () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        this.analysisCanvas.width = this.video.videoWidth;
                        this.analysisCanvas.height = this.video.videoHeight;
                        
                        this.startMotionDetection();
                    };
                    
                    this.updateButtons(true);
                    this.addOutput('üìπ Camera started, monitoring for motion...', 'info');
                    
                } catch (error) {
                    this.addOutput(`‚ùå Camera access failed: ${error.message}`, 'error');
                }
            }
            
            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                if (this.motionDetectionInterval) {
                    clearInterval(this.motionDetectionInterval);
                    this.motionDetectionInterval = null;
                }
                
                this.video.srcObject = null;
                this.updateButtons(false);
                this.addOutput('‚èπÔ∏è Camera stopped', 'info');
                this.hideMotionIndicator();
            }
            
            startMotionDetection() {
                this.motionDetectionInterval = setInterval(() => {
                    this.detectMotion();
                }, 100); // Check for motion every 100ms
                
                this.addOutput('üëÅÔ∏è Motion detection activated', 'info');
            }
            
            detectMotion() {
                if (this.video.readyState !== 4) return;
                
                this.ctx.drawImage(this.video, 0, 0);
                const currentImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                
                if (this.prevImageData) {
                    const motionLevel = this.calculateMotionLevel(this.prevImageData.data, currentImageData.data);
                    
                    if (motionLevel > this.motionThreshold) {
                        this.onMotionDetected(motionLevel);
                    }
                }
                
                this.prevImageData = currentImageData;
            }
            
            calculateMotionLevel(prev, curr) {
                let totalDiff = 0;
                const pixelCount = prev.length / 4;
                
                for (let i = 0; i < prev.length; i += 4) {
                    const rDiff = Math.abs(prev[i] - curr[i]);
                    const gDiff = Math.abs(prev[i + 1] - curr[i + 1]);
                    const bDiff = Math.abs(prev[i + 2] - curr[i + 2]);
                    totalDiff += (rDiff + gDiff + bDiff) / 3;
                }
                
                return (totalDiff / pixelCount) * 100 / 255;
            }
            
            onMotionDetected(motionLevel) {
                this.showMotionIndicator();
                
                const now = Date.now();
                if (now - this.lastAnalysisTime > this.cooldownTime && !this.isAnalyzing) {
                    this.addOutput(`üéØ Motion detected (${motionLevel.toFixed(1)}%), triggering analysis...`, 'motion');
                    this.performAnalysis(false);
                    this.lastAnalysisTime = now;
                }
            }
            
            async performAnalysis(manual = false) {
                if (this.isAnalyzing) {
                    this.addOutput('‚è≥ Analysis already in progress...', 'info');
                    return;
                }
                
                this.isAnalyzing = true;
                
                try {
                    if (manual) {
                        this.addOutput('üîç Manual analysis initiated...', 'info');
                    }
                    
                    // Capture current frame
                    this.analysisCtx.drawImage(this.video, 0, 0);
                    const imageData = this.analysisCanvas.toDataURL('image/jpeg', 0.8);
                    
                    // Perform analysis (simulated for now)
                    const result = await this.analyzeImage(imageData);
                    
                    this.addOutput(result, 'analysis');
                    
                } catch (error) {
                    this.addOutput(`‚ùå Analysis failed: ${error.message}`, 'error');
                } finally {
                    this.isAnalyzing = false;
                    this.updateStatus();
                }
            }
            
            async analyzeImage(imageData) {
                // Simulate analysis delay
                await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1200));
                
                // Simulate different analysis scenarios based on time
                const scenarios = [
                    "Person visible in frame, sitting position, facing camera directly. Indoor environment with good lighting.",
                    "Person detected with movement, appears to be working at desk. Computer equipment visible in background.",
                    "Multiple objects detected: person, furniture, electronic devices. Scene appears to be home office setup.",
                    "Person in casual clothing, relaxed posture. Room appears organized with modern furnishing.",
                    "Active person detected, hands visible suggesting typing or gesture. Well-lit indoor environment.",
                    "Person centered in frame, appears focused on screen. Background shows residential interior."
                ];
                
                const randomScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                const confidence = (85 + Math.random() * 10).toFixed(1);
                
                return `Analysis (${confidence}% confidence): ${randomScenario}`;
            }
            
            showMotionIndicator() {
                this.motionIndicator.classList.add('active');
                setTimeout(() => {
                    this.motionIndicator.classList.remove('active');
                }, 1000);
            }
            
            hideMotionIndicator() {
                this.motionIndicator.classList.remove('active');
            }
            
            addOutput(text, type = 'info') {
                const entry = document.createElement('div');
                entry.className = `output-entry ${type === 'error' ? 'error-entry' : ''}`;
                
                const timestamp = document.createElement('div');
                timestamp.className = 'output-timestamp';
                timestamp.textContent = new Date().toLocaleTimeString();
                
                const textDiv = document.createElement('div');
                textDiv.className = `output-text ${type === 'loading' ? 'loading-indicator' : ''}`;
                textDiv.textContent = text;
                
                entry.appendChild(timestamp);
                entry.appendChild(textDiv);
                
                this.textOutput.insertBefore(entry, this.textOutput.firstChild);
                
                // Keep only last 20 entries
                while (this.textOutput.children.length > 20) {
                    this.textOutput.removeChild(this.textOutput.lastChild);
                }
                
                // Auto-scroll to top for new entries
                this.textOutput.scrollTop = 0;
            }
            
            clearOutput() {
                this.textOutput.innerHTML = '';
                this.addOutput('Output cleared', 'info');
            }
            
            updateButtons(cameraActive) {
                document.getElementById('startBtn').disabled = cameraActive;
                document.getElementById('stopBtn').disabled = !cameraActive;
                document.getElementById('analyzeBtn').disabled = !cameraActive || !this.model?.ready;
            }
            
            updateStatus() {
                const cameraActive = this.stream !== null;
                const modelReady = this.model !== null;
                
                // Camera status
                document.getElementById('cameraStatus').className = `status-dot ${cameraActive ? 'active' : ''}`;
                document.getElementById('cameraStatusText').textContent = `Camera: ${cameraActive ? 'Active' : 'Inactive'}`;
                
                // Motion status  
                document.getElementById('motionStatus').className = `status-dot ${cameraActive ? 'active' : ''}`;
                document.getElementById('motionStatusText').textContent = `Motion: ${cameraActive ? 'Monitoring' : 'Inactive'}`;
                
                // Analysis status
                document.getElementById('analysisStatus').className = `status-dot ${modelReady ? 'active' : ''}`;
                document.getElementById('analysisStatusText').textContent = `Analysis: ${this.isAnalyzing ? 'Running' : modelReady ? 'Ready' : 'Loading'}`;
            }
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            new MotionDetectionVLM();
        });
    </script>
</body>
</html>